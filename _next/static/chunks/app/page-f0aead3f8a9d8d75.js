(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{1187:function(e,t,a){Promise.resolve().then(a.bind(a,1604))},1604:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return Home}});var r=a(7437),l=a(2265),n=a(6704),o=a(105);function SignalChart(e){let{devices:t}=e,normalizeRSSI=e=>Math.max(0,Math.min(100,(e- -100)/70*100)),getSignalColor=e=>"hsla(".concat(1.2*e,", 70%, 50%, 0.8)"),a=[...t].sort((e,t)=>t.rssi-e.rssi),l={labels:a.map(e=>{let t=e.name||"未知設備",a=e.rssi,r=e.updateCount;return["".concat(t," "),"(".concat(a," dBm, ").concat(r,"次)")]}),datasets:[{data:a.map(e=>normalizeRSSI(e.rssi)),backgroundColor:a.map(e=>getSignalColor(normalizeRSSI(e.rssi))),borderColor:a.map(e=>getSignalColor(normalizeRSSI(e.rssi))),borderWidth:1,borderRadius:4,barPercentage:.8,categoryPercentage:.9}]},n=Math.max(600,50*t.length+200);return 0===t.length?(0,r.jsx)("div",{className:"w-full h-[600px] flex items-center justify-center bg-white p-4 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-500 text-xl",children:"尚未掃描到任何設備"})}):(0,r.jsxs)("div",{className:"w-full h-[".concat(n,"px] relative bg-white p-6 rounded-lg"),children:[(0,r.jsx)("h2",{className:"text-center text-2xl font-bold mb-6",children:"藍牙設備信號強度"}),(0,r.jsx)("div",{className:"w-full",style:{height:"".concat(n-100,"px")},children:(0,r.jsx)(o.$Q,{data:l,options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12,callbacks:{label:e=>{let t=a[e.dataIndex];return["MAC: ".concat(t.macAddress),"RSSI: ".concat(t.rssi," dBm"),"信號強度: ".concat(e.raw.toFixed(1),"%"),"更新次數: ".concat(t.updateCount,"次")]}}}},scales:{y:{grid:{display:!1},ticks:{font:{size:14,weight:700},color:e=>{let t=e.index;if(void 0!==t&&t>=0&&t<a.length){let r=e.tick.label;if(Array.isArray(r)&&2===r.length&&e.tick.label===r[1])return getSignalColor(normalizeRSSI(a[t].rssi))}return"rgba(0, 0, 0, 0.9)"},callback:(e,t)=>{let a=l.labels[t];return Array.isArray(a)?a:""}}},x:{beginAtZero:!0,max:100,grid:{color:"rgba(0, 0, 0, 0.1)",lineWidth:1},border:{color:"rgba(0, 0, 0, 0.3)"},ticks:{font:{size:12},color:"rgba(0, 0, 0, 0.7)",callback:e=>"".concat(e,"%")},title:{display:!0,text:"信號強度",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"},padding:{top:10,bottom:10}}}},animation:{duration:300}}})})]})}function Home(){let[e,t]=(0,l.useState)([]),[a,n]=(0,l.useState)(null),[o,s]=(0,l.useState)(""),[i,c]=(0,l.useState)(Date.now()),d=e.filter(e=>e.name.toLowerCase().includes(o.toLowerCase())||e.macAddress.toLowerCase().includes(o.toLowerCase())),connectSerial=async()=>{try{console.log("正在嘗試連接序列埠...");let e=await navigator.serial.requestPort();await e.open({baudRate:115200}),console.log("序列埠連接成功"),n(e),readSerialData(e);let t=e.writable.getWriter();await t.write(new TextEncoder().encode("scan\n")),t.releaseLock(),console.log("掃描已自動開始")}catch(e){console.error("連接序列埠時發生錯誤:",e)}},readSerialData=async e=>{console.log("開始讀取序列埠數據");let a=e.readable.getReader(),r=new TextDecoder,l="";try{for(;;){let{value:e,done:n}=await a.read();if(n){console.log("讀取完成");break}let o=r.decode(e);l+=o;let s=l.split(";");l=s.pop()||"";let i=Date.now(),c=[];for(let e of s)try{if(e.trim().startsWith("BLE_DEVICE:")){let[t,a,r,l]=e.replace("BLE_DEVICE:","").split(",");t&&a&&r&&c.push({macAddress:t,rssi:parseInt(a),name:r,lastSeen:i,updateCount:1})}}catch(e){console.error("解析設備數據時發生錯誤:",e)}c.length>0&&t(e=>{let t=[...e];c.forEach(e=>{let a=t.findIndex(t=>t.macAddress===e.macAddress);if(a>=0){let r=t[a];t[a]={...e,updateCount:r.updateCount+1}}else t.push({...e,updateCount:1})});let a=t.filter(e=>i-e.lastSeen<=3e4);return a})}}catch(e){console.error("讀取數據時發生錯誤:",e)}finally{a.releaseLock()}};return(0,l.useEffect)(()=>()=>{if(a){let e=a.writable.getWriter();e.write(new TextEncoder().encode("stop\n")).then(()=>{e.releaseLock(),a.close()}).catch(console.error)}},[a]),(0,r.jsx)("main",{className:"min-h-screen p-8",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"藍牙設備信號強度監測"}),(0,r.jsxs)("div",{className:"mb-6 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[!a&&(0,r.jsx)("button",{onClick:connectSerial,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"連接序列埠"}),a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("input",{type:"text",value:o,onChange:e=>s(e.target.value),placeholder:"輸入設備名稱或MAC地址進行過濾...",className:"px-4 py-2 border border-gray-300 rounded w-64 focus:outline-none focus:border-blue-500"}),(0,r.jsx)("button",{onClick:()=>{t(e=>e.map(e=>({...e,updateCount:0}))),c(Date.now())},className:"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600",children:"重整圖表"})]})]}),a&&e.length>0&&(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["共找到 ",e.length," 個設備",o&&", 符合條件 ".concat(d.length," 個")]})]}),d.length>0&&(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:(0,r.jsx)(SignalChart,{devices:d},i)})]})})}n.kL.register(n.uw,n.f$,n.ZL,n.Dx,n.u,n.De)}},function(e){e.O(0,[674,547,971,472,744],function(){return e(e.s=1187)}),_N_E=e.O()}]);