(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{1187:function(e,t,a){Promise.resolve().then(a.bind(a,1604))},1604:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return Home}});var r=a(7437),s=a(2265),o=a(6704),l=a(105);a(2656);var n=a(4532);function SignalChart(e){let{devices:t,chartType:a}=e,normalizeRSSI=e=>Math.max(0,Math.min(100,(e- -100)/70*100)),estimateDistance=e=>Math.round(10*Math.pow(10,(Math.abs(e)-Math.abs(-60))/25))/10,getSignalColor=e=>"hsla(".concat(1.2*e,", 70%, 50%, 0.8)"),s=[...t].sort((e,t)=>t.rssi-e.rssi),o={labels:s.map(e=>{let t=e.name||"未知設備",a=e.rssi,r=e.updateCount,s=estimateDistance(a);return["".concat(t," "),"(".concat(a," dBm, ~").concat(s,"m, ").concat(r,"次)")]}),datasets:[{data:s.map(e=>normalizeRSSI(e.rssi)),backgroundColor:s.map(e=>getSignalColor(normalizeRSSI(e.rssi))),borderColor:s.map(e=>getSignalColor(normalizeRSSI(e.rssi))),borderWidth:1,borderRadius:4,barPercentage:.8,categoryPercentage:.9}]},i={datasets:s.map(e=>({label:e.name||"未知設備",data:e.rssiHistory.map(e=>({x:e.timestamp,y:normalizeRSSI(e.rssi)})),borderColor:getSignalColor(normalizeRSSI(e.rssi)),backgroundColor:getSignalColor(normalizeRSSI(e.rssi)),tension:.4,pointRadius:2,borderWidth:2,fill:!1}))},c={responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{position:"top",labels:{font:{size:12}}},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12}},scales:{x:{type:"time",time:{unit:"second",displayFormats:{second:"HH:mm:ss"},tooltipFormat:"yyyy/MM/dd HH:mm:ss"},adapters:{date:{locale:n.c}},title:{display:!0,text:"時間",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"}}},y:{beginAtZero:!0,max:100,title:{display:!0,text:"信號強度 (%)",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"}}}},animation:{duration:300}},d="bar"===a?Math.max(600,50*t.length+200):600;return 0===t.length?(0,r.jsx)("div",{className:"w-full h-[600px] flex items-center justify-center bg-white p-4 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-500 text-xl",children:"尚未掃描到任何設備"})}):(0,r.jsxs)("div",{className:"w-full h-[".concat(d,"px] relative bg-white p-6 rounded-lg"),children:[(0,r.jsx)("h2",{className:"text-center text-2xl font-bold mb-6",children:"藍牙設備信號強度"}),(0,r.jsx)("div",{className:"w-full",style:{height:"".concat(d-100,"px")},children:"bar"===a?(0,r.jsx)(l.$Q,{data:o,options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12,callbacks:{label:e=>{let t=s[e.dataIndex],a=estimateDistance(t.rssi);return["MAC: ".concat(t.macAddress),"RSSI: ".concat(t.rssi," dBm"),"估算距離: ".concat(a," 公尺"),"信號強度: ".concat(e.raw.toFixed(1),"%"),"更新次數: ".concat(t.updateCount,"次")]}}}},scales:{y:{grid:{display:!1},ticks:{font:{size:14,weight:700},color:e=>{let t=e.index;if(void 0!==t&&t>=0&&t<s.length){let a=e.tick.label;if(Array.isArray(a)&&2===a.length&&e.tick.label===a[1])return getSignalColor(normalizeRSSI(s[t].rssi))}return"rgba(0, 0, 0, 0.9)"},callback:(e,t)=>{let a=o.labels[t];return Array.isArray(a)?a:""}}},x:{beginAtZero:!0,max:100,grid:{color:"rgba(0, 0, 0, 0.1)",lineWidth:1},border:{color:"rgba(0, 0, 0, 0.3)"},ticks:{font:{size:12},color:"rgba(0, 0, 0, 0.7)",callback:e=>"".concat(e,"%")},title:{display:!0,text:"信號強度",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"},padding:{top:10,bottom:10}}}},animation:{duration:300}}}):(0,r.jsx)(l.x1,{data:i,options:c})})]})}function Home(){let[e,t]=(0,s.useState)([]),[a,o]=(0,s.useState)(null),[l,n]=(0,s.useState)(""),[i,c]=(0,s.useState)(Date.now()),[d,u]=(0,s.useState)("bar"),[g,m]=(0,s.useState)(!1),p=(0,s.useRef)(g),[b,h]=(0,s.useState)("original"),x=(0,s.useRef)(b);(0,s.useEffect)(()=>{p.current=g},[g]),(0,s.useEffect)(()=>{x.current=b},[b]);let f=e.filter(e=>e.name.toLowerCase().includes(l.toLowerCase())||e.macAddress.toLowerCase().includes(l.toLowerCase())),connectSerial=async()=>{try{console.log("正在嘗試連接序列埠...");let e=await navigator.serial.requestPort();await e.open({baudRate:115200}),console.log("序列埠連接成功"),o(e),readSerialData(e);let t=e.writable.getWriter();await t.write(new TextEncoder().encode("scan\n")),t.releaseLock(),console.log("掃描已自動開始")}catch(e){console.error("連接序列埠時發生錯誤:",e)}},readSerialData=async e=>{console.log("開始讀取序列埠數據");let a=e.readable.getReader(),r=new TextDecoder,s="";try{for(;;){let{value:e,done:o}=await a.read();if(o){console.log("讀取完成");break}let l=r.decode(e);if(s+=l,console.log("serial newData:",l),console.log("serial buffer:",s),"original"===x.current){let e=s.split(";");s=e.pop()||"";let a=Date.now(),r=[];for(let t of e)try{if(t.trim().startsWith("BLE_DEVICE:")){let[e,a,s,o]=t.replace("BLE_DEVICE:","").split(",");if(e&&a&&s){let t=Date.now(),o={macAddress:e,rssi:parseInt(a),name:s,lastSeen:t,updateCount:1,rssiHistory:[{timestamp:t,rssi:parseInt(a)}]};r.push(o)}}}catch(e){console.error("解析設備數據時發生錯誤:",e)}r.length>0&&!p.current&&t(e=>{let t=[...e];r.forEach(e=>{let r=t.findIndex(t=>t.macAddress===e.macAddress);if(r>=0){let s=t[r];t[r]={...e,updateCount:s.updateCount+1,rssiHistory:[...s.rssiHistory,{timestamp:a,rssi:e.rssi}].slice(-50)}}else t.push(e)});let s=t.filter(e=>a-e.lastSeen<=3e4);return s})}else if("new"===x.current){let e=s.match(/\([^()]+,[^()]+,\[[^\]]*\]\)/g)||[];s=s.replace(/\([^()]+,[^()]+,\[[^\]]*\]\)/g,"");let a=Date.now(),r=[];for(let t of e)try{let e=t.slice(1,-1),[s,o,l]=e.split(",");if(o){let e={macAddress:o,rssi:0,name:s,lastSeen:a,updateCount:1,rssiHistory:[{timestamp:a,rssi:0}]};r.push(e)}}catch(e){console.error("解析格式數據發生錯誤:",e)}r.length>0&&!p.current&&t(e=>{let t=[...e];r.forEach(e=>{let r=t.findIndex(t=>t.macAddress===e.macAddress);if(r>=0){let e=t[r];t[r]={...e,updateCount:e.updateCount+1,rssiHistory:[...e.rssiHistory,{timestamp:a,rssi:0}].slice(-50)}}else t.push(e)});let s=t.filter(e=>a-e.lastSeen<=3e4);return s})}}}catch(e){console.error("讀取數據時發生錯誤:",e),o(null),t([]),alert("序列埠連接已斷開，請重新連接")}finally{a.releaseLock()}};return(0,s.useEffect)(()=>()=>{if(a){let e=a.writable.getWriter();e.write(new TextEncoder().encode("stop\n")).then(()=>{e.releaseLock(),a.close()}).catch(console.error)}},[a]),(0,r.jsx)("main",{className:"min-h-screen p-8",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"藍牙設備信號強度監測"}),(0,r.jsxs)("div",{className:"mb-6 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[!a&&(0,r.jsx)("button",{onClick:connectSerial,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"連接序列埠"}),a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("input",{type:"text",value:l,onChange:e=>n(e.target.value),placeholder:"輸入設備名稱或MAC地址進行過濾...",className:"px-4 py-2 border border-gray-300 rounded w-64 focus:outline-none focus:border-blue-500"}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsxs)("select",{value:d,onChange:e=>u(e.target.value),className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500",children:[(0,r.jsx)("option",{value:"bar",children:"柱狀圖"}),(0,r.jsx)("option",{value:"line",children:"折線圖"})]}),(0,r.jsx)("button",{onClick:()=>m(e=>!e),className:"px-4 py-2 rounded text-white ".concat(g?"bg-yellow-500 hover:bg-yellow-600":"bg-gray-500 hover:bg-gray-600"),children:g?"繼續":"暫停"}),(0,r.jsx)("button",{onClick:()=>{t(e=>e.map(e=>({...e,updateCount:0,rssiHistory:"line"===d?[]:e.rssiHistory}))),c(Date.now())},className:"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600",children:"重整圖表"}),(0,r.jsx)("button",{onClick:()=>h(e=>"original"===e?"new":"original"),className:"px-4 py-2 rounded text-white ".concat("original"===b?"bg-indigo-500 hover:bg-indigo-600":"bg-pink-500 hover:bg-pink-600"),children:"original"===b?"切換到解析格式":"切換到原始格式"})]})]})]}),a&&e.length>0&&(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["共找到 ",e.length," 個設備",l&&", 符合條件 ".concat(f.length," 個")]})]}),f.length>0&&(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:(0,r.jsx)(SignalChart,{devices:"new"===b?f.map(e=>({...e,rssi:e.updateCount})):f,chartType:d},i)})]})})}o.kL.register(o.uw,o.f$,o.ZL,o.jn,o.od,o.FB,o.Dx,o.u,o.De)}},function(e){e.O(0,[674,651,971,472,744],function(){return e(e.s=1187)}),_N_E=e.O()}]);