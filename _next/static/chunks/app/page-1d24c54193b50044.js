(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{1187:function(e,t,a){Promise.resolve().then(a.bind(a,4129))},4129:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return Home}});var r=a(7437),s=a(2265),l=a(6704),n=a(105);a(2656);var o=a(4532);function SignalChart(e){var t,a;let{devices:l,chartType:i,dataFormat:c="original"}=e,d="allscanparse"===c,normalizeRSSI=e=>Math.max(0,Math.min(100,(e- -100)/70*100)),normalizeHeartRate=e=>Math.max(0,Math.min(100,(e-40)/160*100)),estimateDistance=e=>Math.round(10*Math.pow(10,(Math.abs(e)-Math.abs(-60))/25))/10,getSignalColor=e=>"hsla(".concat(1.2*e,", 70%, 50%, 0.8)"),u={labels:l.map(e=>{let t=e.name||"未知設備",a=e.rssi,r=e.updateCount;if(d)return["".concat(t," "),"(心率: ".concat(a," BPM, ").concat(r,"次)")];{let e=estimateDistance(a);return["".concat(t," "),"(".concat(a," dBm, ~").concat(e,"m, ").concat(r,"次)")]}}),datasets:[{data:l.map(e=>d?e.rssi:normalizeRSSI(e.rssi)),backgroundColor:l.map(e=>d?getSignalColor(normalizeHeartRate(e.rssi)):getSignalColor(normalizeRSSI(e.rssi))),borderColor:l.map(e=>d?getSignalColor(normalizeHeartRate(e.rssi)):getSignalColor(normalizeRSSI(e.rssi))),borderWidth:1,borderRadius:4,barPercentage:.8,categoryPercentage:.9}]},m={datasets:l.map(e=>({label:e.name||"未知設備",data:e.rssiHistory.map(e=>({x:e.timestamp,y:d?e.rssi:normalizeRSSI(e.rssi)})),borderColor:d?getSignalColor(normalizeHeartRate(e.rssi)):getSignalColor(normalizeRSSI(e.rssi)),backgroundColor:d?getSignalColor(normalizeHeartRate(e.rssi)):getSignalColor(normalizeRSSI(e.rssi)),tension:.4,pointRadius:2,borderWidth:2,fill:!1}))},p={indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12,callbacks:{label:e=>{let t=l[e.dataIndex];if(d)return["ID: ".concat(t.macAddress),"心率: ".concat(t.rssi," BPM"),"更新次數: ".concat(t.updateCount,"次")];{let a=estimateDistance(t.rssi);return["MAC: ".concat(t.macAddress),"RSSI: ".concat(t.rssi," dBm"),"估算距離: ".concat(a," 公尺"),"信號強度: ".concat(e.raw.toFixed(1),"%"),"更新次數: ".concat(t.updateCount,"次")]}}}}},scales:{y:{grid:{display:!1},ticks:{font:{size:14,weight:700},color:e=>{let t=e.index;if(void 0!==t&&t>=0&&t<l.length){let a=e.tick.label;if(Array.isArray(a)&&2===a.length&&e.tick.label===a[1])return d?getSignalColor(normalizeHeartRate(l[t].rssi)):getSignalColor(normalizeRSSI(l[t].rssi))}return"rgba(0, 0, 0, 0.9)"},callback:(e,t)=>{let a=u.labels[t];return Array.isArray(a)?a:""}}},x:{beginAtZero:!0,max:d?Math.max(120,Math.min(220,Math.max(...l.map(e=>e.rssi))+10)):100,grid:{color:"rgba(0, 0, 0, 0.1)",lineWidth:1},border:{color:"rgba(0, 0, 0, 0.3)"},ticks:{font:{size:12},color:"rgba(0, 0, 0, 0.7)",callback:e=>d?"".concat(e):"".concat(e,"%")},title:{display:!0,text:d?"心率 (BPM)":"信號強度",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"},padding:{top:10,bottom:10}}}},animation:{duration:300}},x=(0,s.useMemo)(()=>{if(!d)return null;let e=[];for(let t of l)for(let a of t.rssiHistory)"number"!=typeof a.rssi||Number.isNaN(a.rssi)||e.push(a.rssi);return 0===e.length?{min:40,max:120}:{min:Math.min(...e),max:Math.max(...e)}},[l,d]),h={responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{position:"top",labels:{font:{size:12}}},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12}},scales:{x:{type:"time",time:{unit:"second",displayFormats:{second:"HH:mm:ss"},tooltipFormat:"yyyy/MM/dd HH:mm:ss"},adapters:{date:{locale:o.c}},title:{display:!0,text:"時間",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"}}},y:{beginAtZero:!d,min:d?Math.max(30,(null!==(t=null==x?void 0:x.min)&&void 0!==t?t:40)-10):void 0,max:d?Math.min(240,(null!==(a=null==x?void 0:x.max)&&void 0!==a?a:120)+10):100,title:{display:!0,text:d?"心率 (BPM)":"信號強度 (%)",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"}}}},animation:{duration:300}},g="bar"===i?Math.max(600,50*l.length+200):600;return 0===l.length?(0,r.jsx)("div",{className:"w-full h-[600px] flex items-center justify-center bg-white p-4 rounded-lg",children:(0,r.jsx)("p",{className:"text-gray-500 text-xl",children:"尚未掃描到任何設備"})}):(0,r.jsxs)("div",{className:"w-full h-[".concat(g,"px] relative bg-white p-6 rounded-lg"),children:[(0,r.jsx)("h2",{className:"text-center text-2xl font-bold mb-6",children:"allscanparse"===c?"設備心率監測器":"設備信號強度顯示器"}),(0,r.jsx)("div",{className:"w-full",style:{height:"".concat(g-100,"px")},children:"bar"===i?(0,r.jsx)(n.$Q,{data:u,options:p}):(0,r.jsx)(n.x1,{data:m,options:h})})]})}l.kL.register(l.uw,l.f$,l.ZL,l.jn,l.od,l.FB,l.Dx,l.u,l.De);let i=[{label:"設定掃描模式 (SYS_MODE)",value:"SYS_MODE"},{label:"設定 BLE 掃描參數 (BLE_PARAMS)",value:"BLE_PARAMS"},{label:"設定 ANT+ 掃描參數 (ANT_PARAMS)",value:"ANT_PARAMS"},{label:"設定 BLE 過濾名稱 (BLE_FILTER)",value:"BLE_FILTER"},{label:"查詢 BLE 過濾名稱 (BLE_FILTER_LIST)",value:"BLE_FILTER_LIST"},{label:"設定 ANT+ 過濾 ID (ANT_FILTER)",value:"ANT_FILTER"},{label:"設定 RSSI 閾值 (RSSI_THRESHOLD)",value:"RSSI_THRESHOLD"},{label:"清除 BLE 過濾條件 (BLE_CLEAR_FILTER)",value:"BLE_CLEAR_FILTER"},{label:"清除 ANT+ 過濾條件 (ANT_CLEAR_FILTER)",value:"ANT_CLEAR_FILTER"},{label:"啟動/停止 BLE 掃描 (BLE_SCAN)",value:"BLE_SCAN"},{label:"啟動/停止 ANT+ 掃描 (ANT_SCAN)",value:"ANT_SCAN"},{label:"查詢系統狀態 (STATUS)",value:"STATUS"},{label:"重啟設備 (REBOOT)",value:"REBOOT"},{label:"查詢版本 (VERSION)",value:"VERSION"},{label:"設定 BLE 連線目標 (BLE_CONN)",value:"BLE_CONN"},{label:"查詢 BLE 連線目標 (BLE_CONN_LIST)",value:"BLE_CONN_LIST"},{label:"清除 BLE 連線目標 (BLE_CONN_CLEAR)",value:"BLE_CONN_CLEAR"},{label:"斷開所有 BLE 連線 (BLE_DISCONN_ALL)",value:"BLE_DISCONN_ALL"},{label:"自訂命令",value:"CUSTOM"}],c=["OFF","BLESCAN","ANTSCAN","ALLSCAN","BLESCANPARSE","ALLSCANPARSE","BLECONN"],d=["START","STOP"],u=["START","STOP"],GatewayControlPanel=e=>{let{port:t,response:a,onSend:l}=e,[n,o]=(0,s.useState)("SYS_MODE"),[m,p]=(0,s.useState)({}),[x,h]=(0,s.useState)(""),[g,b]=(0,s.useState)(!1),buildCommand=()=>{let e="";switch(n){case"SYS_MODE":e="SYS_MODE:".concat(m.sysMode||"",";");break;case"BLE_PARAMS":e="BLE_PARAMS:".concat(m.type||"ACTIVE",",").concat(m.interval||100,",").concat(m.window||50,",").concat(m.dup||"FILTER",",").concat(m.report||0,";");break;case"ANT_PARAMS":e="ANT_PARAMS:".concat(m.channel||0,",").concat(m.devtype||"ALL",",").concat(m.freq||57,",").concat(m.period||8192,";");break;case"BLE_FILTER":e="BLE_FILTER:".concat(m.names||"",";");break;case"BLE_FILTER_LIST":e="BLE_FILTER_LIST;";break;case"ANT_FILTER":e="ANT_FILTER:".concat(m.ids||"",";");break;case"RSSI_THRESHOLD":e="RSSI_THRESHOLD:".concat(m.rssi||-70,";");break;case"BLE_CLEAR_FILTER":e="BLE_CLEAR_FILTER;";break;case"ANT_CLEAR_FILTER":e="ANT_CLEAR_FILTER;";break;case"BLE_SCAN":e="BLE_SCAN:".concat(m.mode||"START",";");break;case"ANT_SCAN":e="ANT_SCAN:".concat(m.mode||"START",";");break;case"STATUS":e="STATUS;";break;case"REBOOT":e="REBOOT;";break;case"VERSION":e="VERSION;";break;case"BLE_CONN":let t=(m.conn||"").replace(/[\r\n]+/g,";").split(";").map(e=>e.trim()).filter(Boolean).map(e=>{let[t,a]=e.split(",").map(e=>(e||"").trim());return t&&a?"".concat(t,",").concat(a):""}).filter(Boolean).join(";");e="BLE_CONN:".concat(t,";");break;case"BLE_CONN_LIST":e="BLE_CONN_LIST;";break;case"BLE_CONN_CLEAR":e="BLE_CONN_CLEAR;";break;case"BLE_DISCONN_ALL":e="BLE_DISCONN_ALL;";break;case"CUSTOM":e=x;break;default:e=""}return e.endsWith("\r\n")||(e=e.replace(/\r?\n?$/,"")+"\r\n"),e},sendCommand=async()=>{b(!0),l&&l();try{let e=t.writable.getWriter(),a=buildCommand();await e.write(new TextEncoder().encode(a)),e.releaseLock()}catch(e){}b(!1)};return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"bg-blue-50 rounded-xl shadow-md border border-blue-200 p-6 mb-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Gateway 控制面板"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mb-2",children:[(0,r.jsx)("select",{className:"border rounded px-2 py-1",value:n,onChange:e=>{o(e.target.value),p({}),h("")},children:i.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))}),(()=>{switch(n){case"SYS_MODE":return(0,r.jsxs)("select",{className:"border rounded px-2 py-1",value:m.sysMode||"",onChange:e=>p({...m,sysMode:e.target.value}),children:[(0,r.jsx)("option",{value:"",children:"請選擇模式"}),c.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]});case"BLE_PARAMS":return(0,r.jsxs)("div",{className:"flex flex-col gap-2 w-full",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"掃描類型"}),(0,r.jsxs)("select",{className:"border rounded px-2 py-1",value:m.type||"ACTIVE",onChange:e=>p({...m,type:e.target.value}),children:[(0,r.jsx)("option",{value:"ACTIVE",children:"ACTIVE"}),(0,r.jsx)("option",{value:"PASSIVE",children:"PASSIVE"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"掃描間隔(ms, 2.5-10000, 預設60)"}),(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"間隔(ms)",value:m.interval||100,onChange:e=>p({...m,interval:e.target.value})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"掃描窗口(ms, 2.5-10000, 預設50)"}),(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"窗口(ms)",value:m.window||50,onChange:e=>p({...m,window:e.target.value})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"是否過濾重複廣播"}),(0,r.jsxs)("select",{className:"border rounded px-2 py-1",value:m.dup||"FILTER",onChange:e=>p({...m,dup:e.target.value}),children:[(0,r.jsx)("option",{value:"FILTER",children:"FILTER"}),(0,r.jsx)("option",{value:"NO_FILTER",children:"NO_FILTER"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"報告間隔(ms, 0=即時, 預設0)"}),(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"報告間隔(ms)",value:m.report||0,onChange:e=>p({...m,report:e.target.value})})]})]});case"ANT_PARAMS":return(0,r.jsxs)("div",{className:"flex flex-col gap-2 w-full",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"通道號碼(0-7)"}),(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"通道號碼",value:m.channel||0,onChange:e=>p({...m,channel:e.target.value})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"設備類型(ALL=所有, HRM=心率, BIKE=功率計...)"}),(0,r.jsx)("input",{type:"text",className:"border rounded px-2 py-1",placeholder:"設備類型",value:m.devtype||"ALL",onChange:e=>p({...m,devtype:e.target.value})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"頻率(0-124, 對應2400-2524MHz, 預設57)"}),(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"頻率",value:m.freq||57,onChange:e=>p({...m,freq:e.target.value})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500 min-w-[180px]",children:"通道週期(如8192=4Hz, 4096=8Hz, 32768=1Hz)"}),(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"通道週期",value:m.period||8192,onChange:e=>p({...m,period:e.target.value})})]})]});case"BLE_FILTER":return(0,r.jsx)("div",{className:"w-full my-2",children:(0,r.jsx)("input",{type:"text",className:"border rounded px-2 py-1",style:{width:"700px",minWidth:"500px",maxWidth:"98vw"},placeholder:"名稱,以逗號分隔",value:m.names||"",onChange:e=>p({...m,names:e.target.value})})});case"ANT_FILTER":return(0,r.jsx)("div",{className:"w-full my-2",children:(0,r.jsx)("input",{type:"text",className:"border rounded px-2 py-1",style:{width:"700px",minWidth:"500px",maxWidth:"98vw"},placeholder:"ID,以逗號分隔",value:m.ids||"",onChange:e=>p({...m,ids:e.target.value})})});case"RSSI_THRESHOLD":return(0,r.jsx)("input",{type:"number",className:"border rounded px-2 py-1",placeholder:"RSSI閾值(dBm)",value:m.rssi||-70,onChange:e=>p({...m,rssi:e.target.value})});case"BLE_SCAN":return(0,r.jsx)("select",{className:"border rounded px-2 py-1",value:m.mode||"START",onChange:e=>p({...m,mode:e.target.value}),children:d.map(e=>(0,r.jsx)("option",{value:e,children:e},e))});case"ANT_SCAN":return(0,r.jsx)("select",{className:"border rounded px-2 py-1",value:m.mode||"START",onChange:e=>p({...m,mode:e.target.value}),children:u.map(e=>(0,r.jsx)("option",{value:e,children:e},e))});case"BLE_CONN":return(0,r.jsx)("div",{className:"w-full my-2",children:(0,r.jsx)("textarea",{className:"border rounded px-2 py-1 w-full min-h-[96px] resize-y",style:{minHeight:"96px",maxHeight:"320px"},placeholder:"MAC,PROFILE;...",value:m.conn||"",onChange:e=>p({...m,conn:e.target.value})})});case"CUSTOM":return(0,r.jsx)("input",{type:"text",className:"border rounded px-2 py-1 w-96",placeholder:"自訂命令,如 SYS_MODE:BLESCAN;",value:x,onChange:e=>h(e.target.value)});default:return null}})(),(0,r.jsx)("button",{className:"bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 disabled:bg-gray-400",onClick:sendCommand,disabled:g,children:"發送命令"})]}),(0,r.jsx)("div",{className:"text-xs text-gray-700 whitespace-pre-wrap bg-white rounded p-2 min-h-[40px] border border-gray-200 overflow-auto max-h-40",children:"BLE_CONN_LIST"===n&&a?a.split(/BLE_CONN_LIST:/).filter(Boolean).flatMap((e,t)=>{let a=e.split(";").filter(Boolean);return a.map((e,a)=>{let[s,l]=e.split(",");return(0,r.jsxs)("div",{children:[s," ",l]},t+"-"+a)})}):a||"等待命令回應..."})]})})};function Home(){let[e,t]=(0,s.useState)([]),[a,l]=(0,s.useState)(null),[n,o]=(0,s.useState)(""),[i,c]=(0,s.useState)(Date.now()),[d,u]=(0,s.useState)("bar"),[m,p]=(0,s.useState)(!1),x=(0,s.useRef)(m),[h,g]=(0,s.useState)("original"),b=(0,s.useRef)(h),[S,L]=(0,s.useState)("rssi"),[N,E]=(0,s.useState)(""),[C,f]=(0,s.useState)([]);(0,s.useEffect)(()=>{x.current=m},[m]),(0,s.useEffect)(()=>{b.current=h},[h]);let v=e.filter(e=>e.name.toLowerCase().includes(n.toLowerCase())||e.macAddress.toLowerCase().includes(n.toLowerCase())).sort((e,t)=>{if("rssi"===S)return t.rssi-e.rssi;{let a=e.name.trim(),r=t.name.trim();return a===r?e.macAddress.localeCompare(t.macAddress):a.localeCompare(r,void 0,{numeric:!0,sensitivity:"base"})}}),y=(0,s.useMemo)(()=>{let e="new"===h?v.map(e=>({...e,rssi:e.updateCount})):v;return[...e].sort((e,t)=>{if("rssi"===S)return t.rssi-e.rssi;{let a=e.name.trim(),r=t.name.trim();return a===r?e.macAddress.localeCompare(t.macAddress):a.localeCompare(r,void 0,{numeric:!0,sensitivity:"base"})}})},[v,S,h]),connectSerial=async()=>{try{console.log("正在嘗試連接序列埠...");let e=await navigator.serial.requestPort();await e.open({baudRate:115200}),console.log("序列埠連接成功"),l(e),readSerialData(e)}catch(e){console.error("連接序列埠時發生錯誤:",e)}},readSerialData=async e=>{console.log("開始讀取序列埠數據");let a=e.readable.getReader(),r=new TextDecoder,s="",n="",o=!1;try{for(;;){let{value:e,done:l}=await a.read();if(l){console.log("讀取完成");break}let i=r.decode(e);if(s+=i,console.log("serial newData:",i),console.log("serial buffer:",s),o){n+=i,/;\r?\n/.test(n)&&(E(n.trim()),n="",o=!1);continue}let c=s.match(/(ERROR|OK|STATUS|REBOOT|VERSION|BLE_CONN_LIST|BLE_FILTER_LIST|BLE_CONN_CLEAR|BLE_DISCONN_ALL)[^;]*;/);if(c){let e=c[0].trim(),t=e.match(/ERROR;(.+)/);if(t&&(e="錯誤：".concat(t[1].trim())),/^BLE_CONN_LIST/.test(e)){n=e,o=!0,/;\r?\n$/.test(e)&&(E(e),n="",o=!1),s=s.replace(c[0],"");continue}E(e),s=s.replace(c[0],"")}if("original"===b.current){let e=s.split(";");s=e.pop()||"";let a=Date.now(),r=[];for(let t of e)try{if(t.trim().startsWith("BLE_DEVICE:")){let[e,a,s,l]=t.replace("BLE_DEVICE:","").split(",");if(e&&a&&s){let t=Date.now(),l={macAddress:e.trim().toLowerCase(),rssi:parseInt(a),name:s.trim(),lastSeen:t,updateCount:1,rssiHistory:[{timestamp:t,rssi:parseInt(a)}]};r.push(l)}}}catch(e){console.error("解析設備數據時發生錯誤:",e)}r.length>0&&!x.current&&t(e=>{let t=[...e];r.forEach(e=>{let r=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(r>=0){let s=t[r];t[r]={...e,updateCount:s.updateCount+1,rssiHistory:[...s.rssiHistory,{timestamp:a,rssi:e.rssi}].slice(-50)}}else t.push(e)});let s=t.filter(e=>a-e.lastSeen<=6e4);return s})}else if("new"===b.current){let e=s.match(/\([^()]+,[^()]+,\[[^\]]*\]\)/g)||[];s=s.replace(/\([^()]+,[^()]+,\[[^\]]*\]\)/g,"");let a=Date.now(),r=[];for(let t of e)try{let e=t.slice(1,-1),[s,l,n]=e.split(",");if(l){let e={macAddress:l.trim().toLowerCase(),rssi:0,name:s.trim(),lastSeen:a,updateCount:1,rssiHistory:[{timestamp:a,rssi:0}]};r.push(e)}}catch(e){console.error("解析格式數據發生錯誤:",e)}r.length>0&&!x.current&&t(e=>{let t=[...e];r.forEach(e=>{let r=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(r>=0){let e=t[r];t[r]={...e,updateCount:e.updateCount+1,rssiHistory:[...e.rssiHistory,{timestamp:a,rssi:0}].slice(-50)}}else t.push(e)});let s=t.filter(e=>a-e.lastSeen<=6e4);return s})}else if("profile"===b.current){let e=s.match(/PROFILE_JSON:[^,]+,[^,]+,{[^}]+}/g)||[];s=s.replace(/PROFILE_JSON:[^,]+,[^,]+,{[^}]+}/g,"");let a=Date.now(),r=[];for(let t of e)try{let e=t.match(/^PROFILE_JSON:[^,]+,([^,]+),({[^}]+})$/);if(e){let t=e[1].trim().toLowerCase(),s=e[2],l=JSON.parse(s);if(t&&"number"==typeof l.rssi){let e={macAddress:t,rssi:l.rssi,name:t,lastSeen:a,updateCount:1,rssiHistory:[{timestamp:a,rssi:l.rssi}]};r.push(e)}}}catch(e){console.error("解析 PROFILE_JSON 數據時發生錯誤:",e)}r.length>0&&!x.current&&t(e=>{let t=[...e];r.forEach(e=>{let r=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(r>=0){let s=t[r];t[r]={...e,updateCount:s.updateCount+1,rssiHistory:[...s.rssiHistory,{timestamp:a,rssi:e.rssi}].slice(-50)}}else t.push(e)});let s=t.filter(e=>a-e.lastSeen<=6e4);return s})}else if("allscanparse"===b.current){let e=s.match(/\([^,]+,\d+\)/g)||[];s=s.replace(/\([^,]+,\d+\)/g,"");let a=Date.now(),r=[],l=[];for(let t of e)try{let e=t.slice(1,-1),[s,n]=e.split(",");if(s&&n){let e=parseInt(n),t=s.trim().toLowerCase(),o={macAddress:t,rssi:e,name:"".concat(s.trim()," (HR: ").concat(e,", #1)"),lastSeen:a,updateCount:1,rssiHistory:[{timestamp:a,rssi:e}]};r.push(o),l.push({id:t,timestamp:a,bpm:e})}}catch(e){console.error("解析 ALLSCANPARSE 數據時發生錯誤:",e)}r.length>0&&!x.current&&(t(e=>{let t=[...e];return r.forEach(e=>{let r=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(r>=0){let s=t[r],l=s.updateCount+1;t[r]={...s,rssi:e.rssi,lastSeen:a,updateCount:l,name:"".concat(s.macAddress," (HR: ").concat(e.rssi,", #").concat(l,")"),rssiHistory:[...s.rssiHistory,{timestamp:a,rssi:e.rssi}].slice(-50)}}else t.push(e)}),t}),l.length>0&&f(e=>[...e,...l]))}}}catch(e){console.error("讀取數據時發生錯誤:",e),l(null),t([]),alert("序列埠連接已斷開，請重新連接")}finally{a.releaseLock()}};return(0,s.useEffect)(()=>()=>{if(a){let e=a.writable.getWriter();e.write(new TextEncoder().encode("stop\n")).then(()=>{e.releaseLock(),a.close()}).catch(console.error)}},[a]),(0,r.jsx)("main",{className:"min-h-screen p-8",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,r.jsx)("h1",{className:"text-4xl font-bold mb-4",children:"Gateway 設備監測"}),!a&&(0,r.jsx)("button",{onClick:connectSerial,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-6",children:"連接序列埠"}),a&&(0,r.jsx)("div",{className:"w-full mb-6",children:(0,r.jsx)(GatewayControlPanel,{port:a,response:N,onSend:()=>E("")})}),a&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-4 mb-4",children:[(0,r.jsx)("input",{type:"text",value:n,onChange:e=>o(e.target.value),placeholder:"輸入設備名稱或MAC地址進行過濾...",style:{width:"300px"},className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"}),(0,r.jsxs)("select",{value:S,onChange:e=>L(e.target.value),className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500",children:[(0,r.jsx)("option",{value:"rssi",children:"依 RSSI 強度排序"}),(0,r.jsx)("option",{value:"name",children:"依設備名稱排序"})]}),(0,r.jsxs)("select",{value:d,onChange:e=>u(e.target.value),className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500",children:[(0,r.jsx)("option",{value:"bar",children:"柱狀圖"}),(0,r.jsx)("option",{value:"line",children:"折線圖"})]}),(0,r.jsx)("button",{onClick:()=>p(e=>!e),className:"px-4 py-2 rounded text-white ".concat(m?"bg-yellow-500 hover:bg-yellow-600":"bg-gray-500 hover:bg-gray-600"),children:m?"繼續":"暫停"}),(0,r.jsx)("button",{onClick:()=>{t([]),c(Date.now())},className:"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600",children:"重整圖表"}),(0,r.jsxs)("select",{value:h,onChange:e=>g(e.target.value),className:"px-4 py-2 rounded text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:border-indigo-700",children:[(0,r.jsx)("option",{value:"original",children:"原始格式"}),(0,r.jsx)("option",{value:"new",children:"解析格式"}),(0,r.jsx)("option",{value:"profile",children:"連線格式"}),(0,r.jsx)("option",{value:"allscanparse",children:"ALLSCANPARSE格式"})]}),"allscanparse"===h&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>{if(0===C.length)return;let e=Array.from(new Set(C.map(e=>e.id))).sort(),t=new Map;for(let e of C){let a=1e3*Math.floor(e.timestamp/1e3);t.has(a)||t.set(a,new Map);let r=t.get(a),s=r.get(e.id);(!s||e.timestamp>=s.timestamp)&&r.set(e.id,e)}let a=Array.from(t.keys()).sort((e,t)=>e-t),r=["timestamp","isoTime",...e],s=[];for(let r of a){let a=new Date(r).toISOString(),l=t.get(r),n=[String(r),a];for(let t of e){let e=l.get(t);n.push(e?String(e.bpm):"")}s.push(n)}let l=[r,...s].map(e=>e.map(e=>{let t=e.replace(/"/g,'""');return/[",\n]/.test(t)?'"'.concat(t,'"'):t}).join(",")).join("\n"),n=new Blob([l],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download="heart_rate_matrix_".concat(new Date().toISOString().replace(/[:.]/g,"-"),".csv"),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)},className:"bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700",children:"匯出心率CSV（時間\xd7設備）"}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["紀錄筆數：",C.length]})]}),e.length>0&&(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["共找到 ",e.length," 個設備",n&&", 符合條件 ".concat(v.length," 個")]})]}),v.length>0&&(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:(0,r.jsx)(SignalChart,{devices:y,chartType:d,dataFormat:h},i)})]})})}}},function(e){e.O(0,[674,651,971,472,744],function(){return e(e.s=1187)}),_N_E=e.O()}]);