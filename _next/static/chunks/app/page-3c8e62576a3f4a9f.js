(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{1187:function(e,t,r){Promise.resolve().then(r.bind(r,1604))},1604:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return Home}});var s=r(7437),a=r(2265),o=r(6704),i=r(105);r(2656);var l=r(4532);function SignalChart(e){let{devices:t,chartType:r}=e,normalizeRSSI=e=>Math.max(0,Math.min(100,(e- -100)/70*100)),estimateDistance=e=>Math.round(10*Math.pow(10,(Math.abs(e)-Math.abs(-60))/25))/10,getSignalColor=e=>"hsla(".concat(1.2*e,", 70%, 50%, 0.8)"),a={labels:t.map(e=>{let t=e.name||"未知設備",r=e.rssi,s=e.updateCount,a=estimateDistance(r);return["".concat(t," "),"(".concat(r," dBm, ~").concat(a,"m, ").concat(s,"次)")]}),datasets:[{data:t.map(e=>normalizeRSSI(e.rssi)),backgroundColor:t.map(e=>getSignalColor(normalizeRSSI(e.rssi))),borderColor:t.map(e=>getSignalColor(normalizeRSSI(e.rssi))),borderWidth:1,borderRadius:4,barPercentage:.8,categoryPercentage:.9}]},o={datasets:t.map(e=>({label:e.name||"未知設備",data:e.rssiHistory.map(e=>({x:e.timestamp,y:normalizeRSSI(e.rssi)})),borderColor:getSignalColor(normalizeRSSI(e.rssi)),backgroundColor:getSignalColor(normalizeRSSI(e.rssi)),tension:.4,pointRadius:2,borderWidth:2,fill:!1}))},n={responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{position:"top",labels:{font:{size:12}}},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12}},scales:{x:{type:"time",time:{unit:"second",displayFormats:{second:"HH:mm:ss"},tooltipFormat:"yyyy/MM/dd HH:mm:ss"},adapters:{date:{locale:l.c}},title:{display:!0,text:"時間",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"}}},y:{beginAtZero:!0,max:100,title:{display:!0,text:"信號強度 (%)",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"}}}},animation:{duration:300}},c="bar"===r?Math.max(600,50*t.length+200):600;return 0===t.length?(0,s.jsx)("div",{className:"w-full h-[600px] flex items-center justify-center bg-white p-4 rounded-lg",children:(0,s.jsx)("p",{className:"text-gray-500 text-xl",children:"尚未掃描到任何設備"})}):(0,s.jsxs)("div",{className:"w-full h-[".concat(c,"px] relative bg-white p-6 rounded-lg"),children:[(0,s.jsx)("h2",{className:"text-center text-2xl font-bold mb-6",children:"藍牙設備信號強度"}),(0,s.jsx)("div",{className:"w-full",style:{height:"".concat(c-100,"px")},children:"bar"===r?(0,s.jsx)(i.$Q,{data:a,options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:20,bottom:20,left:20,right:20}},plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"rgba(0, 0, 0, 0.8)",titleFont:{size:14},bodyFont:{size:13},padding:12,callbacks:{label:e=>{let r=t[e.dataIndex],s=estimateDistance(r.rssi);return["MAC: ".concat(r.macAddress),"RSSI: ".concat(r.rssi," dBm"),"估算距離: ".concat(s," 公尺"),"信號強度: ".concat(e.raw.toFixed(1),"%"),"更新次數: ".concat(r.updateCount,"次")]}}}},scales:{y:{grid:{display:!1},ticks:{font:{size:14,weight:700},color:e=>{let r=e.index;if(void 0!==r&&r>=0&&r<t.length){let s=e.tick.label;if(Array.isArray(s)&&2===s.length&&e.tick.label===s[1])return getSignalColor(normalizeRSSI(t[r].rssi))}return"rgba(0, 0, 0, 0.9)"},callback:(e,t)=>{let r=a.labels[t];return Array.isArray(r)?r:""}}},x:{beginAtZero:!0,max:100,grid:{color:"rgba(0, 0, 0, 0.1)",lineWidth:1},border:{color:"rgba(0, 0, 0, 0.3)"},ticks:{font:{size:12},color:"rgba(0, 0, 0, 0.7)",callback:e=>"".concat(e,"%")},title:{display:!0,text:"信號強度",color:"rgba(0, 0, 0, 0.7)",font:{size:14,weight:"bold"},padding:{top:10,bottom:10}}}},animation:{duration:300}}}):(0,s.jsx)(i.x1,{data:o,options:n})})]})}function Home(){let[e,t]=(0,a.useState)([]),[r,o]=(0,a.useState)(null),[i,l]=(0,a.useState)(""),[n,c]=(0,a.useState)(Date.now()),[d,u]=(0,a.useState)("bar"),[m,p]=(0,a.useState)(!1),g=(0,a.useRef)(m),[h,b]=(0,a.useState)("original"),x=(0,a.useRef)(h),[f,y]=(0,a.useState)("rssi");(0,a.useEffect)(()=>{g.current=m},[m]),(0,a.useEffect)(()=>{x.current=h},[h]);let w=e.filter(e=>e.name.toLowerCase().includes(i.toLowerCase())||e.macAddress.toLowerCase().includes(i.toLowerCase())).sort((e,t)=>{if("rssi"===f)return t.rssi-e.rssi;{let r=e.name.trim(),s=t.name.trim();return r===s?e.macAddress.localeCompare(t.macAddress):r.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})}}),C=(0,a.useMemo)(()=>{let e="new"===h?w.map(e=>({...e,rssi:e.updateCount})):w;return[...e].sort((e,t)=>{if("rssi"===f)return t.rssi-e.rssi;{let r=e.name.trim(),s=t.name.trim();return r===s?e.macAddress.localeCompare(t.macAddress):r.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})}})},[w,f,h]),connectSerial=async()=>{try{console.log("正在嘗試連接序列埠...");let e=await navigator.serial.requestPort();await e.open({baudRate:115200}),console.log("序列埠連接成功"),o(e),readSerialData(e);let t=e.writable.getWriter();await t.write(new TextEncoder().encode("scan\n")),t.releaseLock(),console.log("掃描已自動開始")}catch(e){console.error("連接序列埠時發生錯誤:",e)}},readSerialData=async e=>{console.log("開始讀取序列埠數據");let r=e.readable.getReader(),s=new TextDecoder,a="";try{for(;;){let{value:e,done:o}=await r.read();if(o){console.log("讀取完成");break}let i=s.decode(e);if(a+=i,console.log("serial newData:",i),console.log("serial buffer:",a),"original"===x.current){let e=a.split(";");a=e.pop()||"";let r=Date.now(),s=[];for(let t of e)try{if(t.trim().startsWith("BLE_DEVICE:")){let[e,r,a,o]=t.replace("BLE_DEVICE:","").split(",");if(e&&r&&a){let t=Date.now(),o={macAddress:e.trim().toLowerCase(),rssi:parseInt(r),name:a.trim(),lastSeen:t,updateCount:1,rssiHistory:[{timestamp:t,rssi:parseInt(r)}]};s.push(o)}}}catch(e){console.error("解析設備數據時發生錯誤:",e)}s.length>0&&!g.current&&t(e=>{let t=[...e];s.forEach(e=>{let s=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(s>=0){let a=t[s];t[s]={...e,updateCount:a.updateCount+1,rssiHistory:[...a.rssiHistory,{timestamp:r,rssi:e.rssi}].slice(-50)}}else t.push(e)});let a=t.filter(e=>r-e.lastSeen<=3e4);return a})}else if("new"===x.current){let e=a.match(/\([^()]+,[^()]+,\[[^\]]*\]\)/g)||[];a=a.replace(/\([^()]+,[^()]+,\[[^\]]*\]\)/g,"");let r=Date.now(),s=[];for(let t of e)try{let e=t.slice(1,-1),[a,o,i]=e.split(",");if(o){let e={macAddress:o.trim().toLowerCase(),rssi:0,name:a.trim(),lastSeen:r,updateCount:1,rssiHistory:[{timestamp:r,rssi:0}]};s.push(e)}}catch(e){console.error("解析格式數據發生錯誤:",e)}s.length>0&&!g.current&&t(e=>{let t=[...e];s.forEach(e=>{let s=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(s>=0){let e=t[s];t[s]={...e,updateCount:e.updateCount+1,rssiHistory:[...e.rssiHistory,{timestamp:r,rssi:0}].slice(-50)}}else t.push(e)});let a=t.filter(e=>r-e.lastSeen<=3e4);return a})}else if("profile"===x.current){let e=a.match(/PROFILE_JSON:[^,]+,[^,]+,{[^}]+}/g)||[];a=a.replace(/PROFILE_JSON:[^,]+,[^,]+,{[^}]+}/g,"");let r=Date.now(),s=[];for(let t of e)try{let e=t.match(/^PROFILE_JSON:[^,]+,([^,]+),({[^}]+})$/);if(e){let t=e[1].trim().toLowerCase(),a=e[2],o=JSON.parse(a);if(t&&"number"==typeof o.rssi){let e={macAddress:t,rssi:o.rssi,name:t,lastSeen:r,updateCount:1,rssiHistory:[{timestamp:r,rssi:o.rssi}]};s.push(e)}}}catch(e){console.error("解析 PROFILE_JSON 數據時發生錯誤:",e)}s.length>0&&!g.current&&t(e=>{let t=[...e];s.forEach(e=>{let s=t.findIndex(t=>t.macAddress.trim().toLowerCase()===e.macAddress.trim().toLowerCase());if(s>=0){let a=t[s];t[s]={...e,updateCount:a.updateCount+1,rssiHistory:[...a.rssiHistory,{timestamp:r,rssi:e.rssi}].slice(-50)}}else t.push(e)});let a=t.filter(e=>r-e.lastSeen<=3e4);return a})}}}catch(e){console.error("讀取數據時發生錯誤:",e),o(null),t([]),alert("序列埠連接已斷開，請重新連接")}finally{r.releaseLock()}};return(0,a.useEffect)(()=>()=>{if(r){let e=r.writable.getWriter();e.write(new TextEncoder().encode("stop\n")).then(()=>{e.releaseLock(),r.close()}).catch(console.error)}},[r]),(0,s.jsx)("main",{className:"min-h-screen p-8",children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"藍牙設備信號強度監測"}),(0,s.jsxs)("div",{className:"mb-6 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[!r&&(0,s.jsx)("button",{onClick:connectSerial,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"連接序列埠"}),r&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("input",{type:"text",value:i,onChange:e=>l(e.target.value),placeholder:"輸入設備名稱或MAC地址進行過濾...",style:{width:"300px"},className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"}),(0,s.jsxs)("select",{value:f,onChange:e=>y(e.target.value),className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500",children:[(0,s.jsx)("option",{value:"rssi",children:"依 RSSI 強度排序"}),(0,s.jsx)("option",{value:"name",children:"依設備名稱排序"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsxs)("select",{value:d,onChange:e=>u(e.target.value),className:"px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500",children:[(0,s.jsx)("option",{value:"bar",children:"柱狀圖"}),(0,s.jsx)("option",{value:"line",children:"折線圖"})]}),(0,s.jsx)("button",{onClick:()=>p(e=>!e),className:"px-4 py-2 rounded text-white ".concat(m?"bg-yellow-500 hover:bg-yellow-600":"bg-gray-500 hover:bg-gray-600"),children:m?"繼續":"暫停"}),(0,s.jsx)("button",{onClick:()=>{t([]),c(Date.now())},className:"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600",children:"重整圖表"}),(0,s.jsxs)("select",{value:h,onChange:e=>b(e.target.value),className:"px-4 py-2 rounded text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:border-indigo-700",children:[(0,s.jsx)("option",{value:"original",children:"原始格式"}),(0,s.jsx)("option",{value:"new",children:"解析格式"}),(0,s.jsx)("option",{value:"profile",children:"連線格式"})]})]})]})]}),r&&e.length>0&&(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:["共找到 ",e.length," 個設備",i&&", 符合條件 ".concat(w.length," 個")]})]}),w.length>0&&(0,s.jsx)("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:(0,s.jsx)(SignalChart,{devices:C,chartType:d},n)})]})})}o.kL.register(o.uw,o.f$,o.ZL,o.jn,o.od,o.FB,o.Dx,o.u,o.De)}},function(e){e.O(0,[674,651,971,472,744],function(){return e(e.s=1187)}),_N_E=e.O()}]);